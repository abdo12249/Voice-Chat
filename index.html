<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الدردشة الصوتية المتقدمة - الإصدار المستقر</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        body {
            background: radial-gradient(circle at top right, #111827, #000000);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }
        .is-speaking { color: #10b981; transform: scale(1.1); filter: drop-shadow(0 0 8px #10b981); }
        select option { background: #111827; color: white; }
        #chat-messages::-webkit-scrollbar { width: 4px; }
        #chat-messages::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; }
        video { background: #000; width: 100%; height: auto; border-radius: 12px; }
    </style>
</head>
<body>

    <!-- نافذة عرض الشاشة -->
    <div id="video-modal" class="fixed inset-0 bg-black/95 z-[200] hidden flex-col items-center justify-center p-4">
        <div class="w-full max-w-5xl">
            <div class="flex justify-between items-center mb-4 bg-white/5 p-3 rounded-2xl">
                <span id="screen-sharer-name" class="text-blue-400 font-bold">بث مباشر</span>
                <button onclick="closeVideoModal()" class="bg-red-600 hover:bg-red-700 text-white px-5 py-2 rounded-xl text-sm font-bold transition">إغلاق</button>
            </div>
            <div id="screen-share-container" class="rounded-2xl overflow-hidden shadow-2xl border border-white/10"></div>
        </div>
    </div>

    <!-- نافذة الدخول -->
    <div id="name-modal" class="fixed inset-0 bg-black/95 z-[100] flex items-center justify-center p-4">
        <div class="glass p-8 rounded-[2.5rem] max-w-md w-full border-blue-500/20 text-center">
            <h3 class="text-3xl font-bold mb-6 text-blue-500">مرحباً بك</h3>
            <div class="space-y-4 mb-8">
                <input type="text" id="user-name-input" placeholder="اكتب اسمك هنا" class="w-full p-4 rounded-2xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-xl">
                <select id="server-select" class="w-full p-4 rounded-2xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center cursor-pointer">
                    <option value="0">خادم Google (الأسرع)</option>
                    <option value="1">خادم الاستقرار (أوروبا)</option>
                    <option value="2">خادم الطوارئ</option>
                </select>
            </div>
            <button id="save-name-btn" class="w-full bg-blue-600 hover:bg-blue-700 py-4 rounded-2xl font-bold text-lg shadow-lg shadow-blue-600/30 transition-transform active:scale-95">دخول الغرفة</button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 w-full max-w-7xl p-6">
        
        <!-- Sidebar -->
        <div class="lg:col-span-1 space-y-6">
            <div class="glass p-6 rounded-[2rem]">
                <div class="text-center mb-6">
                    <h1 class="text-lg font-bold text-blue-400">إعدادات الاتصال</h1>
                    <p id="current-server-info" class="text-[10px] text-gray-500 mt-1">غير متصل</p>
                </div>

                <!-- زر إصلاح الصوت (بديل مسح السجل) -->
                <button onclick="repairConnection()" class="w-full mb-6 bg-yellow-600/20 hover:bg-yellow-600/40 text-yellow-500 border border-yellow-600/30 py-3 rounded-2xl text-xs font-bold flex items-center justify-center gap-2 transition-all active:scale-95">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                    إصلاح الصوت والاتصال
                </button>

                <!-- الإعدادات -->
                <div class="space-y-4 mb-8 bg-black/30 p-4 rounded-2xl border border-white/5 text-[11px]">
                    <div class="flex justify-between items-center">
                        <label>إلغاء الصدى</label>
                        <input type="checkbox" id="echo-cancel" checked class="w-4 h-4 accent-blue-500">
                    </div>
                    <div class="flex justify-between items-center">
                        <label>تقليل الضجيج</label>
                        <input type="checkbox" id="noise-suppress" checked class="w-4 h-4 accent-blue-500">
                    </div>
                    <div class="pt-2 border-t border-white/5">
                        <p class="text-[9px] text-gray-500 mb-2">جودة الصوت (Bitrate)</p>
                        <input type="range" id="bitrate-slider" min="16" max="128" value="64" class="w-full h-1 accent-blue-500">
                    </div>
                </div>

                <div class="flex justify-center gap-4">
                    <button id="mute-btn" class="w-14 h-14 rounded-full bg-red-600 flex items-center justify-center shadow-lg transition-transform active:scale-90">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path id="mic-on-path" class="hidden" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                            <path id="mic-off-path" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728A9 9 0 015.636 5.636" />
                        </svg>
                    </button>
                    <button id="share-screen-btn" onclick="toggleScreenShare()" class="w-14 h-14 rounded-2xl bg-gray-800 flex items-center justify-center border border-white/10 transition-transform active:scale-90">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                    </button>
                </div>
            </div>
            
            <div id="active-screens-container" class="hidden glass p-4 rounded-[1.5rem] border-blue-500/20">
                <p class="text-[10px] text-blue-400 font-bold mb-3 text-center">بث مباشر متاح</p>
                <div id="active-screens-list" class="space-y-2"></div>
            </div>
        </div>

        <!-- Main Area -->
        <div class="lg:col-span-3 space-y-6">
            <div class="glass p-5 rounded-[1.5rem] flex flex-wrap gap-4 items-center">
                <div class="flex-grow">
                    <p class="text-[9px] text-gray-500 uppercase font-bold">معرف غرفتك</p>
                    <div class="flex items-center gap-2">
                        <span id="my-id" class="text-xl font-mono font-bold text-blue-500">------</span>
                        <button onclick="copyId()" class="p-1 hover:bg-white/10 rounded-lg transition text-gray-400"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg></button>
                    </div>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="peer-id-input" placeholder="ID الصديق..." class="bg-white/5 border border-white/10 p-3 rounded-xl focus:outline-none w-32 md:w-auto text-sm">
                    <button id="call-btn" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-xl font-bold transition shadow-lg shadow-blue-600/20">اتصال</button>
                    <button id="hangup-btn" onclick="hangUp()" class="hidden bg-red-600 hover:bg-red-700 px-6 py-2 rounded-xl font-bold transition">خروج</button>
                </div>
            </div>

            <div class="glass p-6 rounded-[2rem] min-h-[140px]">
                <p class="text-[10px] text-gray-500 font-bold mb-4">الأعضاء المتصلون</p>
                <div id="participants-list" class="flex flex-wrap gap-4">
                    <div id="p-card-me" class="flex items-center gap-3 bg-blue-600/10 px-4 py-2 rounded-2xl border border-blue-600/20">
                        <span id="my-name-tag" class="text-sm font-bold italic">أنت</span>
                        <div id="my-v-meter" class="w-4 h-4 text-gray-600"><svg fill="currentColor" viewBox="0 0 20 20"><path d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z"/></svg></div>
                    </div>
                </div>
            </div>

            <div class="glass p-6 rounded-[2rem] flex flex-col h-[380px]">
                <div id="chat-messages" class="flex-grow overflow-y-auto mb-4 space-y-3 p-1"></div>
                <div class="flex gap-2">
                    <input type="text" id="chat-msg-input" placeholder="اكتب رسالة..." class="flex-grow bg-white/5 border border-white/10 p-4 rounded-2xl focus:outline-none text-sm">
                    <button id="send-btn" class="bg-blue-600 hover:bg-blue-700 p-4 rounded-2xl transition"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg></button>
                </div>
            </div>
        </div>
    </div>

    <div id="audios" class="hidden"></div>

    <script>
        let peer, localStream, myId, myName = "";
        let connections = {}, calls = {}, isMuted = true;
        let activeScreens = {};
        let screenStream = null;
        let isSharingScreen = false;
        let screenCalls = [];

        const iceServers = [
            [{ urls: 'stun:stun.l.google.com:19302' }],
            [{ urls: 'stun:stun.services.mozilla.com' }],
            [{ urls: 'stun:stun.ekiga.net' }]
        ];

        window.onload = () => {
            const saved = localStorage.getItem('voiceChat_userName');
            if (saved) document.getElementById('user-name-input').value = saved;
        };

        // زر إصلاح الاتصال (بديل مسح سجل التصفح)
        function repairConnection() {
            addSystemMsg("جاري إعادة تشغيل المحرك وإصلاح الصوت...");
            // مسح الـ State البرمجي
            Object.values(connections).forEach(c => c.conn.close());
            Object.values(calls).forEach(c => c.close());
            if (peer) peer.destroy();
            
            // إعادة التهيأة
            setTimeout(() => {
                init();
                addSystemMsg("تمت إعادة التشغيل بنجاح.");
            }, 1000);
        }

        async function init() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: document.getElementById('echo-cancel').checked,
                        noiseSuppression: document.getElementById('noise-suppress').checked,
                        autoGainControl: true
                    }
                });
                localStream.getAudioTracks()[0].enabled = false;
                
                const sIdx = document.getElementById('server-select').value;
                document.getElementById('current-server-info').innerText = `متصل بـ: ${document.getElementById('server-select').options[sIdx].text}`;
                
                setupPeer(iceServers[sIdx]);
            } catch (e) {
                addSystemMsg("تنبيه: لم نتمكن من الوصول للميكروفون.");
            }
        }

        function setupPeer(config) {
            myId = Math.floor(100000 + Math.random() * 900000).toString();
            peer = new Peer(myId, { config: { 'iceServers': config } });

            peer.on('open', (id) => { document.getElementById('my-id').innerText = id; });
            
            peer.on('call', (call) => {
                if (call.metadata?.type === 'screen') {
                    call.answer(); // لا نرسل تيار العودة في الشير سكرين
                    handleIncomingScreen(call);
                } else {
                    call.answer(localStream);
                    handleIncomingAudio(call);
                }
            });

            peer.on('connection', setupDataChannel);
        }

        function setupDataChannel(conn) {
            conn.on('open', () => {
                conn.send({ type: 'intro', name: myName });
                connections[conn.peer] = { conn, name: '...' };
                updateStatus();
            });

            conn.on('data', (data) => {
                if (data.type === 'intro') {
                    connections[conn.peer].name = data.name;
                    addParticipantUI(conn.peer, data.name);
                } else if (data.type === 'chat') {
                    addChatMsg(connections[conn.peer].name, data.msg, false);
                } else if (data.type === 'screen-start') {
                    activeScreens[conn.peer] = data.name;
                    updateScreensUI();
                } else if (data.type === 'screen-stop') {
                    delete activeScreens[conn.peer];
                    updateScreensUI();
                    closeVideoModal();
                }
            });

            conn.on('close', () => removeUser(conn.peer));
        }

        async function toggleScreenShare() {
            if (!isSharingScreen) {
                try {
                    // حل مشكلة الشاشة السوداء: طلب فيديو بدقة متوافقة
                    screenStream = await navigator.mediaDevices.getDisplayMedia({ 
                        video: { cursor: "always", frameRate: 15 }, 
                        audio: false 
                    });
                    
                    isSharingScreen = true;
                    document.getElementById('share-screen-btn').classList.replace('bg-gray-800', 'bg-blue-600');
                    
                    Object.keys(connections).forEach(pid => {
                        const call = peer.call(pid, screenStream, { metadata: { type: 'screen' } });
                        screenCalls.push(call);
                        connections[pid].conn.send({ type: 'screen-start', name: myName });
                    });

                    screenStream.getVideoTracks()[0].onended = () => toggleScreenShare();
                } catch (e) { console.error(e); }
            } else {
                if (screenStream) screenStream.getTracks().forEach(t => t.stop());
                isSharingScreen = false;
                document.getElementById('share-screen-btn').classList.replace('bg-blue-600', 'bg-gray-800');
                screenCalls.forEach(c => c.close());
                Object.values(connections).forEach(c => c.conn.send({ type: 'screen-stop' }));
                screenStream = null;
            }
        }

        function handleIncomingScreen(call) {
            call.on('stream', (stream) => {
                const video = document.createElement('video');
                video.srcObject = stream;
                video.autoplay = true;
                video.playsInline = true;
                // حل مشكلة الشاشة السوداء بفرض العرض فور التحميل
                video.onloadedmetadata = () => video.play();
                
                const container = document.getElementById('screen-share-container');
                container.innerHTML = "";
                container.appendChild(video);
                
                document.getElementById('screen-sharer-name').innerText = `بث مباشر من: ${activeScreens[call.peer] || 'صديق'}`;
                document.getElementById('video-modal').classList.remove('hidden');
                document.getElementById('video-modal').classList.add('flex');
            });
        }

        function handleIncomingAudio(call) {
            calls[call.peer] = call;
            call.on('stream', (stream) => {
                let audio = document.getElementById('audio-' + call.peer);
                if (!audio) {
                    audio = document.createElement('audio');
                    audio.id = 'audio-' + call.peer;
                    audio.autoplay = true;
                    document.getElementById('audios').appendChild(audio);
                }
                audio.srcObject = stream;
                visualize(stream, call.peer);
            });
        }

        // زر خروج (Hang Up)
        function hangUp() {
            addSystemMsg("تم الخروج من المحادثة.");
            location.reload(); // أضمن طريقة لإنهاء كافة العمليات وتنظيف الذاكرة
        }

        function removeUser(pid) {
            if (connections[pid]) {
                addSystemMsg(`غادر ${connections[pid].name}`);
                delete connections[pid];
                delete activeScreens[pid];
                updateScreensUI();
                document.getElementById('p-card-' + pid)?.remove();
                document.getElementById('audio-' + pid)?.remove();
                updateStatus();
            }
        }

        function updateScreensUI() {
            const container = document.getElementById('active-screens-container');
            const list = document.getElementById('active-screens-list');
            list.innerHTML = "";
            const keys = Object.keys(activeScreens);
            container.classList.toggle('hidden', keys.length === 0);
            keys.forEach(k => {
                const b = document.createElement('button');
                b.className = "w-full bg-blue-600/20 hover:bg-blue-600/40 text-blue-400 py-2 rounded-xl text-[10px] font-bold";
                b.innerText = `مشاهدة بث ${activeScreens[k]}`;
                b.onclick = () => document.getElementById('video-modal').classList.replace('hidden', 'flex');
                list.appendChild(b);
            });
        }

        function addParticipantUI(id, name) {
            if (document.getElementById('p-card-' + id)) return;
            const div = document.createElement('div');
            div.id = 'p-card-' + id;
            div.className = "flex items-center gap-3 bg-white/5 px-4 py-2 rounded-2xl border border-white/10";
            div.innerHTML = `<span class="text-sm font-medium">${name}</span><div id="v-${id}" class="w-4 h-4 text-gray-700"><svg fill="currentColor" viewBox="0 0 20 20"><path d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z"/></svg></div>`;
            document.getElementById('participants-list').appendChild(div);
        }

        function visualize(stream, pid) {
            const ctx = new AudioContext();
            const source = ctx.createMediaStreamSource(stream);
            const analyzer = ctx.createAnalyser();
            analyzer.fftSize = 32;
            source.connect(analyzer);
            const data = new Uint8Array(analyzer.frequencyBinCount);
            function check() {
                if (!connections[pid] && pid !== 'me') return;
                analyzer.getByteFrequencyData(data);
                const vol = data.reduce((a, b) => a + b) / data.length;
                const icon = pid === 'me' ? document.getElementById('my-v-meter') : document.getElementById('v-' + pid);
                if (icon) icon.className = vol > 10 ? 'w-4 h-4 is-speaking' : 'w-4 h-4 text-gray-700';
                requestAnimationFrame(check);
            }
            check();
        }

        function addChatMsg(user, text, isMe) {
            const div = document.createElement('div');
            div.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'}`;
            div.innerHTML = `<div class="${isMe ? 'bg-blue-600 rounded-2xl rounded-tr-none' : 'bg-white/10 rounded-2xl rounded-tl-none'} p-3 max-w-[85%]"><p class="text-[8px] opacity-50 mb-1">${user}</p><p class="text-sm">${text}</p></div>`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addSystemMsg(t) {
            const d = document.createElement('div');
            d.className = "text-center text-[9px] text-gray-600 my-2 italic";
            d.innerText = `• ${t} •`;
            chatMessages.appendChild(d);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function updateStatus() {
            const count = Object.keys(connections).length;
            document.getElementById('hangup-btn').classList.toggle('hidden', count === 0);
            document.getElementById('call-btn').classList.toggle('hidden', count > 0);
        }

        document.getElementById('mute-btn').onclick = function() {
            isMuted = !isMuted;
            localStream.getAudioTracks()[0].enabled = !isMuted;
            this.className = isMuted ? 'w-14 h-14 rounded-full bg-red-600 flex items-center justify-center' : 'w-14 h-14 rounded-full bg-green-600 flex items-center justify-center';
            document.getElementById('mic-on-path').classList.toggle('hidden', isMuted);
            document.getElementById('mic-off-path').classList.toggle('hidden', !isMuted);
            if (!isMuted) visualize(localStream, 'me');
        };

        document.getElementById('save-name-btn').onclick = () => {
            myName = document.getElementById('user-name-input').value.trim();
            if (!myName) return;
            localStorage.setItem('voiceChat_userName', myName);
            document.getElementById('my-name-tag').innerText = myName + " (أنت)";
            document.getElementById('name-modal').classList.add('hidden');
            init();
        };

        document.getElementById('call-btn').onclick = () => {
            const tid = document.getElementById('peer-id-input').value.trim();
            if (tid && tid !== myId) {
                const conn = peer.connect(tid);
                setupDataChannel(conn);
                const call = peer.call(tid, localStream);
                handleIncomingAudio(call);
            }
        };

        document.getElementById('send-btn').onclick = () => {
            const i = document.getElementById('chat-msg-input');
            if (!i.value.trim()) return;
            Object.values(connections).forEach(c => c.conn.send({ type: 'chat', msg: i.value }));
            addChatMsg('أنت', i.value, true);
            i.value = "";
        };

        function closeVideoModal() { document.getElementById('video-modal').classList.replace('flex', 'hidden'); }
        function copyId() { navigator.clipboard.writeText(myId); addSystemMsg("تم نسخ المعرف"); }
    </script>
</body>
</html>
