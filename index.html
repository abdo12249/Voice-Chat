<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق الدردشة الصوتية والكتابية</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-family: sans-serif;
            padding: 20px;
        }
        #chat-messages::-webkit-scrollbar {
            width: 5px;
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        .mic-active {
            box-shadow: 0 0 20px #4ade80;
            border-color: #4ade80;
            background-color: rgba(74, 222, 128, 0.2) !important;
        }
        .mic-muted {
            box-shadow: 0 0 15px #ef4444;
            border-color: #ef4444;
            background-color: rgba(239, 68, 68, 0.2) !important;
        }
        .speaking-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #4ade80;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }
        /* Custom Modal Styles */
        #custom-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
    </style>
</head>
<body>

    <!-- Custom Modal for Alerts/Confirmations -->
    <div id="custom-modal">
        <div class="glass p-8 rounded-2xl max-w-sm w-full text-center shadow-2xl">
            <h3 id="modal-title" class="text-xl font-bold mb-4">تنبيه</h3>
            <p id="modal-body" class="mb-6 text-gray-300">هل تريد قبول المكالمة؟</p>
            <div id="modal-actions" class="flex gap-4">
                <button id="modal-confirm" class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded-xl font-bold transition">نعم</button>
                <button id="modal-cancel" class="flex-1 bg-red-600 hover:bg-red-700 py-2 rounded-xl font-bold transition">إلغاء</button>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-5xl">
        <!-- Right Side: Connection Controls -->
        <div class="glass p-6 rounded-2xl shadow-2xl flex flex-col justify-between">
            <div>
                <h1 class="text-2xl font-bold mb-4 text-center text-blue-400">التحكم بالصوت</h1>
                <div id="status" class="mb-4 text-xs bg-yellow-500/30 py-1 px-3 rounded-full inline-block w-full text-center">جاري تهيئة النظام...</div>

                <div class="mb-6 text-center">
                    <p class="text-gray-400 text-sm mb-2">معرفك الخاص:</p>
                    <div class="flex items-center gap-2 bg-black/40 p-3 rounded-xl border border-white/10">
                        <span id="my-id" class="font-mono text-lg tracking-wider flex-grow text-center text-green-400">-------</span>
                        <button onclick="copyId()" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded-md text-sm transition shadow-md active:scale-95">نسخ</button>
                    </div>
                </div>

                <div class="flex flex-col items-center mb-6">
                    <button id="mute-btn" class="w-20 h-20 rounded-full bg-gray-700 flex items-center justify-center transition-all duration-200 border-2 border-transparent relative hover:scale-105 active:scale-95">
                        <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path id="mic-on-path" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                            <path id="mic-off-path" class="hidden" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728A9 9 0 015.636 5.636" />
                        </svg>
                    </button>
                    <span id="mic-label" class="text-[12px] text-gray-400 mt-2 font-bold italic">أنت صامت</span>
                </div>

                <div class="space-y-4">
                    <input type="text" id="peer-id" placeholder="أدخل معرف الصديق" class="w-full p-3 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-lg">
                    <button id="call-btn" class="w-full bg-green-600 hover:bg-green-700 py-3 rounded-xl font-bold text-lg transition shadow-lg flex items-center justify-center gap-2 active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                        </svg>
                        بدء الاتصال
                    </button>
                    <button id="hangup-btn" class="hidden w-full bg-red-600 hover:bg-red-700 py-3 rounded-xl font-bold text-lg transition shadow-lg active:scale-95">إنهاء المكالمة</button>
                </div>
            </div>

            <div id="active-call" class="hidden mt-6 p-4 bg-green-500/20 rounded-xl border border-green-500/30 text-center">
                <span id="remote-speaking-status" class="text-green-400 font-medium italic">انتظار صوت الصديق...</span>
                <div id="volume-meter" class="w-full h-1 bg-gray-700 mt-2 rounded-full overflow-hidden">
                    <div id="volume-bar" class="h-full bg-green-500 w-0 transition-all duration-75"></div>
                </div>
                <button id="resume-audio-btn" class="mt-3 w-full bg-blue-500 hover:bg-blue-600 py-2 rounded-lg font-bold transition active:scale-95">تفعيل الصوت (انقر للسماع)</button>
            </div>
        </div>

        <!-- Left Side: Chat Messages -->
        <div class="glass p-6 rounded-2xl shadow-2xl flex flex-col h-[500px]">
            <h2 class="text-xl font-bold mb-4 border-b border-white/10 pb-2">الدردشة الكتابية</h2>
            <div id="chat-messages" class="flex-grow overflow-y-auto space-y-3 mb-4 p-2 text-sm flex flex-col">
                <div class="text-gray-500 text-center italic">لا توجد رسائل بعد</div>
            </div>
            <div class="flex gap-2">
                <input type="text" id="chat-input" placeholder="اكتب رسالة..." class="flex-grow p-3 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="send-btn" class="bg-blue-600 hover:bg-blue-700 px-4 rounded-xl transition active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9-2-9-18-9 18 9 2zm0 0v-8" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden audio element for remote stream -->
    <audio id="remote-audio" playsinline></audio>

    <script>
        let peer;
        let localStream;
        let currentCall;
        let dataConn;
        let audioContext;
        let isMuted = false;
        
        let localAnalyser;
        let localDataArray;
        let remoteAnalyser;
        let remoteDataArray;

        const myIdDisplay = document.getElementById('my-id');
        const statusDisplay = document.getElementById('status');
        const callBtn = document.getElementById('call-btn');
        const hangupBtn = document.getElementById('hangup-btn');
        const muteBtn = document.getElementById('mute-btn');
        const micIconOn = document.getElementById('mic-on-path');
        const micIconOff = document.getElementById('mic-off-path');
        const peerIdInput = document.getElementById('peer-id');
        const remoteAudio = document.getElementById('remote-audio');
        const activeCallIndicator = document.getElementById('active-call');
        const micLabel = document.getElementById('mic-label');
        const remoteSpeakingStatus = document.getElementById('remote-speaking-status');
        const resumeAudioBtn = document.getElementById('resume-audio-btn');
        const volumeBar = document.getElementById('volume-bar');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');

        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalConfirm = document.getElementById('modal-confirm');
        const modalCancel = document.getElementById('modal-cancel');

        function showModal(title, body, onConfirm, onCancel = null) {
            modalTitle.innerText = title;
            modalBody.innerText = body;
            modal.style.display = 'flex';
            modalConfirm.onclick = () => { modal.style.display = 'none'; if(onConfirm) onConfirm(); };
            modalCancel.onclick = () => { modal.style.display = 'none'; if(onCancel) onCancel(); };
            if(!onCancel) modalCancel.style.display = 'none'; else modalCancel.style.display = 'block';
        }

        async function initMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
                });
                statusDisplay.innerText = "جاري الاتصال بالسيرفر...";
                setupPeer();
            } catch (err) {
                statusDisplay.innerText = "خطأ: تأكد من تفعيل المايكروفون";
                statusDisplay.className = "mb-4 text-xs bg-red-500/50 py-1 px-3 rounded-full inline-block w-full text-center";
            }
        }

        async function ensureAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }
            return audioContext;
        }

        function setupAudioContext() {
            ensureAudioContext().then(ctx => {
                if (localStream && !localAnalyser) {
                    const source = ctx.createMediaStreamSource(localStream);
                    localAnalyser = ctx.createAnalyser();
                    localAnalyser.fftSize = 256;
                    source.connect(localAnalyser);
                    localDataArray = new Uint8Array(localAnalyser.frequencyBinCount);
                    monitorLocalVoice();
                }
            });
        }

        function monitorLocalVoice() {
            if (!localAnalyser || isMuted) { requestAnimationFrame(monitorLocalVoice); return; }
            localAnalyser.getByteFrequencyData(localDataArray);
            const average = localDataArray.reduce((a, b) => a + b) / localDataArray.length;
            if (average > 15) { 
                muteBtn.classList.add('mic-active');
                micLabel.innerText = "أنت تتحدث الآن...";
                micLabel.className = "text-[12px] text-green-400 mt-2 font-bold";
            } else {
                muteBtn.classList.remove('mic-active');
                micLabel.innerText = "أنت صامت";
                micLabel.className = "text-[12px] text-gray-400 mt-2 font-bold italic";
            }
            requestAnimationFrame(monitorLocalVoice);
        }

        function setupRemoteVisualizer(remoteStream) {
            ensureAudioContext().then(ctx => {
                // Connect stream to context to ensure it's processed
                const remoteSource = ctx.createMediaStreamSource(remoteStream);
                
                // Visualizer Setup
                remoteAnalyser = ctx.createAnalyser();
                remoteAnalyser.fftSize = 256;
                remoteSource.connect(remoteAnalyser);
                
                // CRITICAL: Connecting to destination ensures the audio actually reaches the speakers
                // when processed through the AudioContext.
                remoteSource.connect(ctx.destination);

                remoteDataArray = new Uint8Array(remoteAnalyser.frequencyBinCount);
                
                function monitorRemoteVoice() {
                    if(!currentCall) return;
                    remoteAnalyser.getByteFrequencyData(remoteDataArray);
                    const average = remoteDataArray.reduce((a, b) => a + b) / remoteDataArray.length;
                    volumeBar.style.width = Math.min(100, average * 5) + "%";
                    if (average > 1.5) { 
                        remoteSpeakingStatus.innerHTML = '<span class="speaking-indicator"></span> الصديق يتحدث الآن...';
                        remoteSpeakingStatus.className = "text-green-400 font-medium italic";
                    } else {
                        remoteSpeakingStatus.innerText = "انتظار صوت الصديق...";
                        remoteSpeakingStatus.className = "text-gray-400 font-medium italic";
                    }
                    requestAnimationFrame(monitorRemoteVoice);
                }
                monitorRemoteVoice();
            });
        }

        function setupPeer() {
            const iceConfig = {
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun.cloudflare.com:3478' }
                ]
            };

            peer = new Peer(undefined, { config: iceConfig, debug: 1 });

            peer.on('open', (id) => {
                myIdDisplay.innerText = id;
                statusDisplay.innerText = "متصل - جاهز";
                statusDisplay.className = "mb-4 text-xs bg-green-500/50 py-1 px-3 rounded-full inline-block w-full text-center";
                setupAudioContext(); 
            });

            peer.on('call', (call) => {
                showModal("مكالمة واردة", "يرغب صديق في الاتصال بك صوتياً، هل تقبل؟", () => {
                    ensureAudioContext().then(() => {
                        call.answer(localStream);
                        handleCall(call);
                    });
                }, () => {
                    call.close();
                });
            });

            peer.on('connection', (conn) => {
                dataConn = conn;
                setupChatListeners();
            });

            peer.on('error', (err) => {
                if(err.type === 'peer-unavailable') showModal("خطأ", "هذا المعرف غير موجود.", null);
                statusDisplay.innerText = "خطأ في الاتصال";
            });
        }

        callBtn.onclick = async () => {
            const remoteId = peerIdInput.value.trim();
            if (!remoteId) return showModal("تنبيه", "أدخل معرف الصديق أولاً", null);
            await ensureAudioContext();
            const call = peer.call(remoteId, localStream);
            handleCall(call);
            dataConn = peer.connect(remoteId);
            setupChatListeners();
        };

        function handleCall(call) {
            currentCall = call;
            updateUI(true);
            call.on('stream', (remoteStream) => {
                // Attach to audio element
                remoteAudio.srcObject = remoteStream;
                
                // Use a direct play attempt
                const playPromise = remoteAudio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        resumeAudioBtn.innerText = "الصوت يعمل";
                        resumeAudioBtn.classList.replace('bg-blue-500', 'bg-green-600/50');
                    }).catch(error => {
                        console.log("Autoplay prevented, showing manual play button");
                        resumeAudioBtn.classList.remove('hidden');
                    });
                }

                // Add to visualizer and AudioContext destination
                setupRemoteVisualizer(remoteStream); 
            });
            call.on('close', endCall);
        }

        resumeAudioBtn.onclick = async () => {
            await ensureAudioContext();
            remoteAudio.play();
        };

        function setupChatListeners() {
            if (!dataConn) return;
            dataConn.on('open', () => {
                updateUI(true);
                addMessage("نظام", "تم الاتصال بالصديق", "text-blue-400 bg-blue-400/10 w-full text-center font-bold");
            });
            dataConn.on('data', (data) => {
                addMessage("الصديق", data, "text-white bg-white/10 self-start border border-white/5");
            });
            dataConn.on('close', endCall);
        }

        function sendMessage() {
            const msg = chatInput.value.trim();
            if (!msg || !dataConn || !dataConn.open) return;
            dataConn.send(msg);
            addMessage("أنت", msg, "text-green-400 bg-green-400/10 self-end border border-green-400/10");
            chatInput.value = "";
        }

        function addMessage(sender, text, colorClass) {
            if (chatMessages.innerText.includes("لا توجد رسائل")) chatMessages.innerHTML = "";
            const div = document.createElement('div');
            div.className = `p-3 rounded-xl max-w-[85%] mb-2 ${colorClass} shadow-sm backdrop-blur-sm`;
            div.innerHTML = `<span class="block text-[10px] opacity-60 mb-1 font-bold">${sender}</span><span class="break-words">${text}</span>`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        sendBtn.onclick = sendMessage;
        chatInput.onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };
        hangupBtn.onclick = endCall;

        function endCall() {
            if (currentCall) currentCall.close();
            if (dataConn) dataConn.close();
            updateUI(false);
            remoteAudio.srcObject = null;
            volumeBar.style.width = "0%";
            currentCall = null;
        }

        function updateUI(inCall) {
            callBtn.classList.toggle('hidden', inCall);
            hangupBtn.classList.toggle('hidden', !inCall);
            activeCallIndicator.classList.toggle('hidden', !inCall);
        }

        function copyId() {
            const id = myIdDisplay.innerText;
            if (id === "-------") return;
            const temp = document.createElement('input');
            document.body.appendChild(temp);
            temp.value = id;
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            showModal("نجاح", "تم نسخ المعرف", null);
        }

        muteBtn.onclick = () => {
            if (!localStream) return;
            isMuted = !isMuted;
            localStream.getAudioTracks()[0].enabled = !isMuted;
            muteBtn.classList.toggle('mic-muted', isMuted);
            micIconOn.classList.toggle('hidden', isMuted);
            micIconOff.classList.toggle('hidden', !isMuted);
        };

        window.onload = initMedia;
    </script>
</body>
</html>