<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق الدردشة الصوتية الجماعية</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-family: sans-serif;
            padding: 20px;
        }
        #chat-messages::-webkit-scrollbar {
            width: 5px;
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        .speaking-border {
            border-color: #4ade80 !important;
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.3);
        }
        #custom-modal, #name-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .mic-indicator {
            transition: all 0.3s ease;
        }
        .is-speaking {
            color: #4ade80;
            filter: drop-shadow(0 0 5px #4ade80);
            transform: scale(1.2);
        }
    </style>
</head>
<body>

    <!-- نافذة إدخال الاسم -->
    <div id="name-modal" style="display: flex;">
        <div class="glass p-8 rounded-2xl max-w-sm w-full text-center shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-blue-400">أهلاً بك!</h3>
            <p class="mb-6 text-gray-300">من فضلك أدخل اسمك للبدء في الدردشة</p>
            <input type="text" id="user-name-input" placeholder="اسمك هنا..." class="w-full p-3 mb-4 rounded-xl bg-white/5 border border-white/20 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-lg">
            <button id="save-name-btn" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-xl font-bold transition active:scale-95 text-lg">دخول</button>
        </div>
    </div>

    <!-- نافذة التنبيهات -->
    <div id="custom-modal">
        <div class="glass p-8 rounded-2xl max-w-sm w-full text-center shadow-2xl">
            <h3 id="modal-title" class="text-xl font-bold mb-4">تنبيه</h3>
            <p id="modal-body" class="mb-6 text-gray-300"></p>
            <div id="modal-actions" class="flex gap-4">
                <button id="modal-confirm" class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded-xl font-bold transition">حسناً</button>
                <button id="modal-cancel" class="flex-1 bg-red-600 hover:bg-red-700 py-2 rounded-xl font-bold transition">إلغاء</button>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 w-full max-w-6xl">
        
        <!-- لوحة التحكم -->
        <div class="glass p-6 rounded-2xl shadow-2xl flex flex-col justify-between lg:col-span-1">
            <div>
                <h1 class="text-2xl font-bold mb-2 text-center text-blue-400">دردشة جماعية</h1>
                <div id="status" class="mb-4 text-[10px] bg-yellow-500/30 py-1 px-3 rounded-full inline-block w-full text-center italic text-gray-200">جاري الاتصال...</div>

                <div class="mb-6 text-center">
                    <p class="text-gray-400 text-sm mb-2 font-medium">معرفك (ID):</p>
                    <div class="flex items-center gap-2 bg-black/40 p-3 rounded-xl border border-white/10">
                        <span id="my-id" class="font-mono text-lg tracking-wider flex-grow text-center text-green-400 font-bold">-------</span>
                        <button onclick="copyId()" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded-md text-sm transition active:scale-95">نسخ</button>
                    </div>
                </div>

                <div class="flex flex-col items-center mb-6">
                    <button id="mute-btn" class="w-16 h-16 rounded-full bg-gray-700 flex items-center justify-center transition-all duration-200 border-2 border-transparent relative hover:scale-105 active:scale-95">
                        <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path id="mic-on-path" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                            <path id="mic-off-path" class="hidden" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728A9 9 0 015.636 5.636" />
                        </svg>
                    </button>
                    <span id="mic-label" class="text-[12px] text-gray-400 mt-2 font-bold italic">أنت صامت</span>
                </div>

                <div class="space-y-3">
                    <input type="text" id="peer-id" placeholder="أدخل ID الصديق" class="w-full p-3 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center">
                    <button id="call-btn" class="w-full bg-green-600 hover:bg-green-700 py-3 rounded-xl font-bold transition shadow-lg flex items-center justify-center gap-2">
                        انضمام
                    </button>
                    <button id="hangup-btn" class="hidden w-full bg-red-600 hover:bg-red-700 py-3 rounded-xl font-bold transition shadow-lg">مغادرة</button>
                </div>
            </div>
        </div>

        <!-- قائمة المشاركين والدردشة -->
        <div class="lg:col-span-2 flex flex-col gap-6">
            
            <!-- قائمة المتواجدين -->
            <div class="glass p-4 rounded-2xl flex flex-col h-1/3">
                <h2 class="text-sm font-bold mb-3 text-gray-400 border-b border-white/10 pb-2">المشاركون الآن</h2>
                <div id="participants-container" class="flex flex-wrap gap-2 overflow-y-auto pr-1">
                    <div class="flex items-center gap-2 bg-blue-500/20 px-3 py-2 rounded-lg border border-blue-500/30">
                        <span id="my-name-display" class="text-sm font-bold">أنت</span>
                        <svg id="my-mic-indicator" class="h-4 w-4 text-gray-400 mic-indicator" fill="currentColor" viewBox="0 0 20 20"><path d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z"/></svg>
                    </div>
                </div>
            </div>

            <!-- الدردشة -->
            <div class="glass p-6 rounded-2xl flex flex-col h-2/3 max-h-[400px]">
                <h2 class="text-lg font-bold mb-4 border-b border-white/10 pb-2 flex justify-between">
                    <span>دردشة المجموعة</span>
                    <span id="room-status" class="text-xs text-gray-500 font-normal self-center">أنت وحدك</span>
                </h2>
                <div id="chat-messages" class="flex-grow overflow-y-auto space-y-3 mb-4 p-2 text-sm flex flex-col">
                    <div class="text-gray-500 text-center italic">لا توجد رسائل بعد</div>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="chat-input" placeholder="اكتب رسالة..." class="flex-grow p-3 rounded-xl bg-white/5 border border-white/10 focus:outline-none">
                    <button id="send-btn" class="bg-blue-600 hover:bg-blue-700 px-4 rounded-xl transition">
                        إرسال
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="remote-audios-container" class="hidden"></div>

    <script>
        let peer;
        let localStream;
        let connections = {};
        let calls = {};
        let audioContext;
        let isMuted = false;
        let myId = "";
        let myName = localStorage.getItem('chat-name') || "";

        const myIdDisplay = document.getElementById('my-id');
        const statusDisplay = document.getElementById('status');
        const callBtn = document.getElementById('call-btn');
        const hangupBtn = document.getElementById('hangup-btn');
        const muteBtn = document.getElementById('mute-btn');
        const micIconOn = document.getElementById('mic-on-path');
        const micIconOff = document.getElementById('mic-off-path');
        const peerIdInput = document.getElementById('peer-id');
        const micLabel = document.getElementById('mic-label');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const modal = document.getElementById('custom-modal');
        const nameModal = document.getElementById('name-modal');
        const userNameInput = document.getElementById('user-name-input');
        const saveNameBtn = document.getElementById('save-name-btn');
        const participantsContainer = document.getElementById('participants-container');
        const roomStatus = document.getElementById('room-status');

        // إدارة إدخال الاسم
        if (myName) {
            nameModal.style.display = 'none';
            document.getElementById('my-name-display').innerText = myName + " (أنت)";
            initMedia();
        }

        saveNameBtn.onclick = () => {
            const name = userNameInput.value.trim();
            if (name.length < 2) return;
            myName = name;
            localStorage.setItem('chat-name', name);
            nameModal.style.display = 'none';
            document.getElementById('my-name-display').innerText = myName + " (أنت)";
            initMedia();
        };

        function generateNumericID() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        function showModal(title, body, onConfirm, onCancel = null) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-body').innerText = body;
            modal.style.display = 'flex';
            document.getElementById('modal-confirm').onclick = () => { modal.style.display = 'none'; if(onConfirm) onConfirm(); };
            const cancelBtn = document.getElementById('modal-cancel');
            if(!onCancel) cancelBtn.style.display = 'none'; else {
                cancelBtn.style.display = 'block';
                cancelBtn.onclick = () => { modal.style.display = 'none'; if(onCancel) onCancel(); };
            }
        }

        async function initMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
                });
                setupPeer();
                setupLocalVisualizer(localStream);
            } catch (err) {
                statusDisplay.innerText = "تأكد من إعطاء صلاحية المايكروفون";
                statusDisplay.classList.add('bg-red-500/30');
            }
        }

        async function ensureAudioContext() {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') await audioContext.resume();
            return audioContext;
        }

        function setupPeer() {
            myId = generateNumericID();
            peer = new Peer(myId, { 
                config: { 'iceServers': [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun.cloudflare.com:3478' }] },
                debug: 1 
            });

            peer.on('open', (id) => {
                myIdDisplay.innerText = id;
                statusDisplay.innerText = "متصل - جاهز لاستقبال مكالمات";
                statusDisplay.className = "mb-4 text-[10px] bg-green-500/30 py-1 px-3 rounded-full inline-block w-full text-center";
            });

            peer.on('call', (call) => {
                ensureAudioContext().then(() => {
                    call.answer(localStream);
                    handleIncomingStream(call);
                });
            });

            peer.on('connection', (conn) => {
                setupDataConnection(conn);
            });
        }

        callBtn.onclick = async () => {
            const remoteId = peerIdInput.value.trim();
            if (!remoteId || remoteId === myId) return;
            
            await ensureAudioContext();
            const conn = peer.connect(remoteId);
            setupDataConnection(conn);

            const call = peer.call(remoteId, localStream);
            handleIncomingStream(call);
            updateUI(true);
        };

        function setupDataConnection(conn) {
            conn.on('open', () => {
                // إرسال الاسم الخاص بي عند فتح الاتصال
                conn.send({ type: 'name-intro', name: myName });
                
                connections[conn.peer] = { conn, name: "مجهول" };
                
                const otherPeers = Object.keys(connections).filter(id => id !== conn.peer);
                conn.send({ type: 'peer-list', peers: otherPeers });
                
                updateRoomUI();
            });

            conn.on('data', (data) => {
                if (data.type === 'name-intro') {
                    connections[conn.peer].name = data.name;
                    addParticipantUI(conn.peer, data.name);
                    addMessage("نظام", `دخل ${data.name} الغرفة`, "text-blue-300 italic text-[10px] w-full text-center");
                } else if (data.type === 'peer-list') {
                    data.peers.forEach(id => {
                        if (!connections[id] && id !== myId) {
                            const newConn = peer.connect(id);
                            setupDataConnection(newConn);
                            const newCall = peer.call(id, localStream);
                            handleIncomingStream(newCall);
                        }
                    });
                } else if (data.type === 'chat') {
                    addMessage(connections[conn.peer].name, data.msg, "text-white bg-white/10 self-start border border-white/5");
                }
            });

            conn.on('close', () => {
                if(connections[conn.peer]) {
                    const name = connections[conn.peer].name;
                    addMessage("نظام", `غادر ${name} الغرفة`, "text-red-300 italic text-[10px] w-full text-center");
                    removeParticipantUI(conn.peer);
                }
                delete connections[conn.peer];
                updateRoomUI();
            });
        }

        function handleIncomingStream(call) {
            calls[call.peer] = call;
            call.on('stream', (remoteStream) => {
                let audio = document.getElementById('audio-' + call.peer);
                if (!audio) {
                    audio = document.createElement('audio');
                    audio.id = 'audio-' + call.peer;
                    audio.autoplay = true;
                    document.getElementById('remote-audios-container').appendChild(audio);
                }
                audio.srcObject = remoteStream;
                setupRemoteVisualizer(remoteStream, call.peer);
            });
        }

        function setupLocalVisualizer(stream) {
            ensureAudioContext().then(ctx => {
                const source = ctx.createMediaStreamSource(stream);
                const analyser = ctx.createAnalyser();
                analyser.fftSize = 64;
                source.connect(analyser);
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                const mic = document.getElementById('my-mic-indicator');

                function update() {
                    analyser.getByteFrequencyData(dataArray);
                    const avg = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    if (avg > 10 && !isMuted) mic.classList.add('is-speaking');
                    else mic.classList.remove('is-speaking');
                    requestAnimationFrame(update);
                }
                update();
            });
        }

        function setupRemoteVisualizer(stream, peerId) {
            ensureAudioContext().then(ctx => {
                const source = ctx.createMediaStreamSource(stream);
                const analyser = ctx.createAnalyser();
                analyser.fftSize = 64;
                source.connect(analyser);
                source.connect(ctx.destination);
                const dataArray = new Uint8Array(analyser.frequencyBinCount);

                function update() {
                    if (!stream.active || !calls[peerId]) return;
                    analyser.getByteFrequencyData(dataArray);
                    const avg = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    const mic = document.getElementById('mic-' + peerId);
                    if (mic) {
                        if (avg > 10) mic.classList.add('is-speaking');
                        else mic.classList.remove('is-speaking');
                    }
                    requestAnimationFrame(update);
                }
                update();
            });
        }

        function addParticipantUI(id, name) {
            if (document.getElementById('part-' + id)) return;
            const div = document.createElement('div');
            div.id = 'part-' + id;
            div.className = "flex items-center gap-2 bg-white/5 px-3 py-2 rounded-lg border border-white/10 transition-all";
            div.innerHTML = `
                <span class="text-sm font-medium">${name}</span>
                <svg id="mic-${id}" class="h-4 w-4 text-gray-400 mic-indicator" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z"/>
                </svg>
            `;
            participantsContainer.appendChild(div);
        }

        function removeParticipantUI(id) {
            const el = document.getElementById('part-' + id);
            if (el) el.remove();
        }

        function updateRoomUI() {
            const count = Object.keys(connections).length;
            roomStatus.innerText = count === 0 ? "أنت وحدك" : `متصل مع ${count} أشخاص`;
            updateUI(count > 0);
        }

        function sendMessage() {
            const msg = chatInput.value.trim();
            if (!msg) return;
            Object.values(connections).forEach(p => p.conn.send({ type: 'chat', msg }));
            addMessage("أنت", msg, "text-green-400 bg-green-400/10 self-end border border-green-400/10");
            chatInput.value = "";
        }

        function addMessage(sender, text, colorClass) {
            if (chatMessages.innerText.includes("لا توجد رسائل")) chatMessages.innerHTML = "";
            const div = document.createElement('div');
            div.className = `p-2 rounded-lg max-w-[85%] mb-1 ${colorClass} shadow-sm`;
            div.innerHTML = `<span class="block text-[9px] opacity-60 font-bold">${sender}</span><span class="break-words">${text}</span>`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        sendBtn.onclick = sendMessage;
        chatInput.onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };
        
        hangupBtn.onclick = () => {
            Object.values(calls).forEach(c => c.close());
            Object.values(connections).forEach(c => c.conn.close());
            calls = {};
            connections = {};
            participantsContainer.innerHTML = `<div class="flex items-center gap-2 bg-blue-500/20 px-3 py-2 rounded-lg border border-blue-500/30">
                        <span id="my-name-display" class="text-sm font-bold">${myName} (أنت)</span>
                        <svg id="my-mic-indicator" class="h-4 w-4 text-gray-400 mic-indicator" fill="currentColor" viewBox="0 0 20 20"><path d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z"/></svg>
                    </div>`;
            updateRoomUI();
        };

        function updateUI(active) {
            callBtn.classList.toggle('hidden', active);
            hangupBtn.classList.toggle('hidden', !active);
        }

        muteBtn.onclick = () => {
            isMuted = !isMuted;
            localStream.getAudioTracks()[0].enabled = !isMuted;
            muteBtn.classList.toggle('bg-red-600', isMuted);
            micIconOn.classList.toggle('hidden', isMuted);
            micIconOff.classList.toggle('hidden', !isMuted);
            micLabel.innerText = isMuted ? "أنت صامت" : "المايك يعمل";
        };

        function copyId() {
            const id = myIdDisplay.innerText;
            const temp = document.createElement('input');
            document.body.appendChild(temp);
            temp.value = id;
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            showModal("تم النسخ", "شارك الـ ID مع أصدقائك: " + id, null);
        }
    </script>
</body>
</html>
